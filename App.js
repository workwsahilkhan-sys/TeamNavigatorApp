import React, { useState, useEffect, useRef } from 'react';\nimport { StyleSheet, View, Text, TouchableOpacity, FlatList, TextInput, Button, Alert } from 'react-native';\nimport { NavigationContainer } from '@react-navigation/native';\nimport { createStackNavigator } from '@react-navigation/stack';\nimport MapView, { Marker } from 'react-native-maps';\nimport * as Location from 'expo-location';\nimport { Magnetometer } from 'expo-sensors';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport io from 'socket.io-client';\nimport { GiftedChat } from 'react-native-gifted-chat';\nimport { BleManager } from 'react-native-ble-plx';\nimport RNPickerSelect from 'react-native-picker-select';\n\nconst Stack = createStackNavigator();\nconst bleManager = new BleManager();\n\n// Global state for connectivity\nlet connectivityMode = 'internet'; // 'internet', 'bluetooth', 'lora'\nlet socket = null;\nlet bleDevices = [];\n\n// LoRa placeholder: Assume external device connected via Bluetooth\n// Research: Use Meshtastic firmware on LoRa devices, communicate via BLE\n\nfunction MapScreen({ navigation }) {\n  const [location, setLocation] = useState(null);\n  const [heading, setHeading] = useState(0);\n  const [elevation, setElevation] = useState(0);\n  const [waypoints, setWaypoints] = useState([]);\n  const [teammates, setTeammates] = useState([]);\n  const [sharedWaypoints, setSharedWaypoints] = useState([]);\n\n  useEffect(() => {\n    loadData();\n    setupLocation();\n    setupConnectivity();\n    return () => {\n      if (socket) socket.disconnect();\n      bleManager.destroy();\n    };\n  }, []);\n\n  const loadData = async () => {\n    const storedTeammates = await AsyncStorage.getItem('teammates');\n    if (storedTeammates) setTeammates(JSON.parse(storedTeammates));\n    const storedWaypoints = await AsyncStorage.getItem('waypoints');\n    if (storedWaypoints) setWaypoints(JSON.parse(storedWaypoints));\n  };\n\n  const saveData = async () => {\n    await AsyncStorage.setItem('teammates', JSON.stringify(teammates));\n    await AsyncStorage.setItem('waypoints', JSON.stringify(waypoints));\n  };\n\n  const setupLocation = async () => {\n    let { status } = await Location.requestForegroundPermissionsAsync();\n    if (status !== 'granted') {\n      Alert.alert('Permission denied');\n      return;\n    }\n    let loc = await Location.getCurrentPositionAsync({});\n    setLocation(loc);\n    setElevation(loc.coords.altitude);\n    shareLocation(loc.coords);\n\n    Magnetometer.addListener((data) => {\n      let angle = Math.atan2(data.y, data.x) * (180 / Math.PI);\n      setHeading(angle);\n    });\n    Magnetometer.setUpdateInterval(100);\n  };\n\n  const setupConnectivity = () => {\n    if (connectivityMode === 'internet') {\n      socket = io('http://localhost:3000'); // Change to your server IP\n      socket.on('locationUpdate', (data) => {\n        setTeammates(prev => prev.map(t => t.id === data.id ? { ...t, lat: data.latitude, lon: data.longitude } : t));\n      });\n      socket.on('waypoint', (data) => {\n        setSharedWaypoints(prev => [...prev, data]);\n      });\n    } else if (connectivityMode === 'bluetooth') {\n      bleManager.startDeviceScan(null, null, (error, device) => {\n        if (error) return;\n        if (!bleDevices.find(d => d.id === device.id)) {\n          bleDevices.push(device);\n        }\n      });\n    } else if (connectivityMode === 'lora') {\n      // Placeholder: Connect to LoRa device via BLE\n      // Use Meshtastic BLE service UUIDs\n      Alert.alert('LoRa mode: Connect LoRa device manually');\n    }\n  };\n\n  const shareLocation = (coords) => {\n    if (connectivityMode === 'internet' && socket) {\n      socket.emit('location', coords);\n    } else if (connectivityMode === 'bluetooth') {\n      // Send via BLE to connected devices\n      bleDevices.forEach(device => {\n        // Implement sending location\n      });\n    } else if (connectivityMode === 'lora') {\n      // Send via LoRa\n    }\n  };\n\n  const addWaypoint = (e) => {\n    const { coordinate } = e.nativeEvent;\n    const newWp = { id: Date.now().toString(), ...coordinate };\n    setWaypoints([...waypoints, newWp]);\n    saveData();\n    if (connectivityMode === 'internet' && socket) {\n      socket.emit('waypoint', newWp);\n    }\n  };\n\n  return (\n    <View style={styles.container}>\n      <MapView\n        style={styles.map}\n        initialRegion={{\n          latitude: location ? location.coords.latitude : 37.78825,\n          longitude: location ? location.coords.longitude : -122.4324,\n          latitudeDelta: 0.0922,\n          longitudeDelta: 0.0421,\n        }}\n        showsUserLocation={true}\n        showsCompass={true}\n        onLongPress={addWaypoint}\n        mapType=\"terrain\" // For topographic\n      >\n        {location && (\n          <Marker\n            coordinate={{\n              latitude: location.coords.latitude,\n              longitude: location.coords.longitude,\n            }}\n            title=\"You\"\n          />\n        )}\n        {waypoints.map((wp) => (\n          <Marker key={wp.id} coordinate={wp} title=\"Waypoint\" />\n        ))}\n        {sharedWaypoints.map((wp) => (\n          <Marker key={wp.id} coordinate={wp} title=\"Shared Waypoint\" pinColor=\"blue\" />\n        ))}\n        {teammates.map((tm) => (\n          <Marker key={tm.id} coordinate={{ latitude: tm.lat || 0, longitude: tm.lon || 0 }} title={tm.callsign} pinColor=\"green\" />\n        ))}\n      </MapView>\n      <View style={styles.overlay}>\n        <Text>Lat: {location ? location.coords.latitude.toFixed(6) : 'Loading'}</Text>\n        <Text>Lon: {location ? location.coords.longitude.toFixed(6) : 'Loading'}</Text>\n        <Text>Heading: {heading.toFixed(0)}Â°</Text>\n        <Text>Elevation: {elevation.toFixed(0)}m</Text>\n      </View>\n      <View style={styles.navButtons}>\n        <TouchableOpacity style={styles.button} onPress={() => navigation.navigate('Teammates')}>\n          <Text>Teammates</Text>\n        </TouchableOpacity>\n        <TouchableOpacity style={styles.button} onPress={() => navigation.navigate('Chat')}>\n          <Text>Chat</Text>\n        </TouchableOpacity>\n        <TouchableOpacity style={styles.button} onPress={() => navigation.navigate('Settings')}>\n          <Text>Settings</Text>\n        </TouchableOpacity>\n      </View>\n    </View>\n  );\n}\n\nfunction TeammatesScreen({ navigation }) {\n  const [teammates, setTeammates] = useState([]);\n  const [newTeammate, setNewTeammate] = useState({ name: '', callsign: '', group: '' });\n\n  useEffect(() => {\n    loadTeammates();\n  }, []);\n\n  const loadTeammates = async () => {\n    const stored = await AsyncStorage.getItem('teammates');\n    if (stored) setTeammates(JSON.parse(stored));\n  };\n\n  const saveTeammates = async (list) => {\n    setTeammates(list);\n    await AsyncStorage.setItem('teammates', JSON.stringify(list));\n  };\n\n  const addTeammate = () => {\n    if (newTeammate.name && newTeammate.callsign) {\n      const list = [...teammates, { ...newTeammate, id: Date.now().toString() }];\n      saveTeammates(list);\n      setNewTeammate({ name: '', callsign: '', group: '' });\n    }\n  };\n\n  return (\n    <View style={styles.container}>\n      <Text style={styles.title}>Teammates</Text>\n      <FlatList\n        data={teammates}\n        keyExtractor={(item) => item.id}\n        renderItem={({ item }) => (\n          <View style={styles.teammateItem}>\n            <Text>{item.name} ({item.callsign}) - {item.group}</Text>\n          </View>\n        )}\n      />\n      <TextInput\n        placeholder=\"Name\"\n        value={newTeammate.name}\n        onChangeText={(text) => setNewTeammate({ ...newTeammate, name: text })}\n        style={styles.input}\n      />\n      <TextInput\n        placeholder=\"Callsign\"\n        value={newTeammate.callsign}\n        onChangeText={(text) => setNewTeammate({ ...newTeammate, callsign: text })}\n        style={styles.input}\n      />\n      <TextInput\n        placeholder=\"Group\"\n        value={newTeammate.group}\n        onChangeText={(text) => setNewTeammate({ ...newTeammate, group: text })}\n        style={styles.input}\n      />\n      <Button title=\"Add Teammate\" onPress={addTeammate} />\n      <TouchableOpacity style={styles.button} onPress={() => navigation.goBack()}>\n        <Text>Back to Map</Text>\n      </TouchableOpacity>\n    </View>\n  );\n}\n\nfunction ChatScreen({ navigation }) {\n  const [messages, setMessages] = useState([]);\n\n  useEffect(() => {\n    if (connectivityMode === 'internet' && socket) {\n      socket.on('message', (msg) => {\n        setMessages(previous => GiftedChat.append(previous, [msg]));\n      });\n    }\n  }, []);\n\n  const onSend = (msgs = []) => {\n    setMessages(previous => GiftedChat.append(previous, msgs));\n    if (connectivityMode === 'internet' && socket) {\n      socket.emit('message', msgs[0]);\n    } else if (connectivityMode === 'bluetooth') {\n      // Send via BLE\n    } else if (connectivityMode === 'lora') {\n      // Send via LoRa\n    }\n  };\n\n  return (\n    <View style={styles.container}>\n      <GiftedChat\n        messages={messages}\n        onSend={onSend}\n        user={{\n          _id: 1,\n        }}\n      />\n      <TouchableOpacity style={styles.button} onPress={() => navigation.goBack()}>\n        <Text>Back to Map</Text>\n      </TouchableOpacity>\n    </View>\n  );\n}\n\nfunction SettingsScreen({ navigation }) {\n  const [mode, setMode] = useState(connectivityMode);\n\n  const changeMode = (value) => {\n    connectivityMode = value;\n    setMode(value);\n    // Re-setup connectivity\n  };\n\n  return (\n    <View style={styles.container}>\n      <Text style={styles.title}>Settings</Text>\n      <Text>Connectivity Mode:</Text>\n      <RNPickerSelect\n        onValueChange={changeMode}\n        items={[\n          { label: 'Internet', value: 'internet' },\n          { label: 'Bluetooth', value: 'bluetooth' },\n          { label: 'LoRa', value: 'lora' },\n        ]}\n        value={mode}\n      />\n      <Text>Offline Maps: Download tiles in Mapbox app or configure provider.</Text>\n      <Text>Hardware: For LoRa, pair Meshtastic device via Bluetooth.</Text>\n      <TouchableOpacity style={styles.button} onPress={() => navigation.goBack()}>\n        <Text>Back to Map</Text>\n      </TouchableOpacity>\n    </View>\n  );\n}\n\nexport default function App() {\n  return (\n    <NavigationContainer>\n      <Stack.Navigator initialRouteName=\"Map\">\n        <Stack.Screen name=\"Map\" component={MapScreen} />\n        <Stack.Screen name=\"Teammates\" component={TeammatesScreen} />\n        <Stack.Screen name=\"Chat\" component={ChatScreen} />\n        <Stack.Screen name=\"Settings\" component={SettingsScreen} />\n      </Stack.Navigator>\n    </NavigationContainer>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n  },\n  map: {\n    width: '100%',\n    height: '100%',\n  },\n  overlay: {\n    position: 'absolute',\n    top: 50,\n    left: 10,\n    backgroundColor: 'rgba(255,255,255,0.8)',\n    padding: 10,\n    borderRadius: 5,\n  },\n  navButtons: {\n    position: 'absolute',\n    bottom: 20,\n    left: 10,\n    right: 10,\n    flexDirection: 'row',\n    justifyContent: 'space-around',\n  },\n  button: {\n    backgroundColor: '#ddd',\n    padding: 10,\n    borderRadius: 5,\n  },\n  title: {\n    fontSize: 24,\n    textAlign: 'center',\n    margin: 10,\n  },\n  teammateItem: {\n    padding: 10,\n    borderBottomWidth: 1,\n    borderBottomColor: '#ccc',\n  },\n  input: {\n    borderWidth: 1,\n    borderColor: '#ccc',\n    padding: 10,\n    margin: 10,\n  },\n});\n